#!/usr/bin/env bash
set -euo pipefail

if [[ "${EUID}" -ne 0 ]]; then
  exec sudo PROFILE="${PROFILE:-personal}" "$0" "$@"
fi

host="$(scutil --get LocalHostName 2>/dev/null || hostname -s || echo "")"
if [[ -z "${host}" && -n "${HOSTNAME:-}" ]]; then
  host="${HOSTNAME}"
fi
user="${SUDO_USER:-${USER:-$(id -un)}}"
profile="${PROFILE:-personal}"

if [[ -z "${host}" ]]; then
  echo "HOSTNAME is required" >&2
  exit 1
fi

if [[ -z "${user}" ]]; then
  echo "USER is required" >&2
  exit 1
fi

HOSTNAME="${host}" USER="${user}" darwin-rebuild switch --impure --flake ".#${profile}"
